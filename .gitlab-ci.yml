image: docker:latest
variables:
  IMAGE_NAME: ${CI_REGISTRY}/${CI_PROJECT_PATH}
  
stages:          # List of stages for jobs, and their order of execution
  - prebuild
  - build


PreBuild:
  stage: prebuild
  script:
  - set

Construction:       # This job runs in the build stage, which runs first.
  stage: build
  script:
    # Build
    - docker image build -t ${IMAGE_NAME}:build-temp  .
    - docker image tag      ${IMAGE_NAME}:build-temp  ${IMAGE_NAME}:${CI_COMMIT_TAG:-devel}

    # Login, push, et logout
    - echo ${CI_REGISTRY_PASSWORD} | docker login ${CI_REGISTRY} -u ${CI_REGISTRY_USER} --password-stdin
    - docker image push                               ${IMAGE_NAME}:${CI_COMMIT_TAG:-devel}
    - docker logout
    
  after_script:
    # Nettoyage du runner (merci de laisser cet endroit aussi propre que vous l'avez trouvé en entrant...)
    - docker image rm       ${IMAGE_NAME}:build-temp  ${IMAGE_NAME}:${CI_COMMIT_TAG:-devel}
    
  # tags:
  # - runner-builder

# Push:
  # stage: push
  # script:
  # - docker compose push
# 
# Deploiement:
  # stage: deploy
  # script:
  # - echo "Un jour, on déploie l'application"
